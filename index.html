<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Rady Presale</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>

<style>
    body {
        background: #000814;
        color: #bde0fe;
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        text-align: center;
    }

    h1 {
        margin-top: 40px;
        color: #48cae4;
        font-size: 32px;
        text-shadow: 0 0 10px #48cae4;
    }

    .container {
        width: 90%;
        max-width: 450px;
        margin: 30px auto;
        padding: 30px;
        background: rgba(10, 20, 40, 0.6);
        border: 1px solid #48cae4;
        border-radius: 12px;
        box-shadow: 0 0 20px #0096c7;
    }

    input {
        width: 90%;
        padding: 12px;
        margin-top: 10px;
        border: none;
        border-radius: 8px;
        background: #001d3d;
        color: #caf0f8;
        font-size: 16px;
    }

    button {
        width: 95%;
        padding: 12px;
        background: #0077b6;
        border: none;
        border-radius: 8px;
        color: white;
        margin-top: 20px;
        cursor: pointer;
        font-weight: bold;
        font-size: 18px;
        box-shadow: 0 0 10px #0096c7;
    }
    button:hover {
        background: #00b4d8;
    }

    #status {
        margin-top: 20px;
        font-size: 16px;
        color: #90e0ef;
        min-height: 25px;
    }

    .countdown {
        font-size: 20px;
        margin-top: 20px;
        color: #48cae4;
        text-shadow: 0 0 6px #48cae4;
    }

    /* POPUP */
    .popup {
        position: fixed;
        top: 40%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #03045e;
        padding: 20px;
        border: 2px solid #90e0ef;
        border-radius: 12px;
        display: none;
        box-shadow: 0 0 20px #00b4d8;
        color: #caf0f8;
    }
</style>
</head>
<body>

<h1>Rady Pre-Sale</h1>

<div class="container">
    <h3>Comprar Tokens Rady</h3>

    <!-- Entrada quantidade de tokens -->
    <input type="number" id="tokenAmount" placeholder="Quantidade de tokens">

    <!-- Preço por token (puxado do contrato depois) -->
    <p id="ethCost">Valor em ETH: 0</p>

    <button onclick="buyTokens()">Comprar</button>

    <button onclick="claimTokens()">Claim (Liberar Tokens)</button>

    <div class="countdown">
        <p><b>Presale termina em:</b></p>
        <span id="timer">Carregando...</span>
    </div>

    <div id="status"></div>
</div>

<!-- POPUP FUNDS -->
<div id="popupFunds" class="popup">⚠️ Fundos insuficientes!</div>

<!-- POPUP CLAIM ERROR -->
<div id="popupClaim" class="popup">⚠️ Claim ainda não liberado!</div>

<script>
/* ------------------------------
   CONFIGURAÇÃO DOS CONTRATOS
--------------------------------*/
const PRESALE_ADDRESS = "0xA34825C95aD8EE3552d2865A1368B8124DD30234";
const TOKEN_ADDRESS   = "0x1955405e6EdB21560889422f86365fd0C6deC998";

/* ABI SIMPLIFICADA */
const presaleABI = [
    "function buyTokens(uint256 amount) payable",
    "function claimTokens()",
    "function tokenPrice() view returns(uint256)",
    "function presaleEnd() view returns(uint256)"
];

/* ------------------------------
   CONECTAR WALLET
--------------------------------*/
let provider;
let signer;
let presale;

async function connect() {
    if (!window.ethereum) {
        alert("MetaMask não detectada.");
        return;
    }

    provider = new ethers.BrowserProvider(window.ethereum);
    signer = await provider.getSigner();
    presale = new ethers.Contract(PRESALE_ADDRESS, presaleABI, signer);

    document.getElementById("status").innerText = "Wallet conectada!";
    loadPresaleData();
}

connect();

/* ------------------------------
   ATUALIZAR PREÇO EM TEMPO REAL
--------------------------------*/
async function loadPresaleData() {
    const price = await presale.tokenPrice();
    window.tokenPrice = price / 1e18;

    const end = await presale.presaleEnd();
    startCountdown(Number(end));
}

document.getElementById("tokenAmount").addEventListener("input", () => {
    const qty = document.getElementById("tokenAmount").value;
    const ethValue = qty * window.tokenPrice;
    document.getElementById("ethCost").innerText = "Valor em ETH: " + ethValue.toFixed(6);
});

/* ------------------------------
   COMPRAR TOKENS
--------------------------------*/
async function buyTokens() {
    try {
        const qty = document.getElementById("tokenAmount").value;
        if (qty <= 0) return;

        const value = qty * window.tokenPrice;

        const tx = await presale.buyTokens(
            qty,
            { value: ethers.parseEther(value.toString()) }
        );

        document.getElementById("status").innerText = "Processando compra...";
        await tx.wait();

        document.getElementById("status").innerText = "Compra concluída!";
    }
    catch (err) {
        if (err.message.includes("insufficient funds")) {
            showPopup("popupFunds");
            return;
        }
        document.getElementById("status").innerText = "Erro: " + err.message;
    }
}

/* ------------------------------
   CLAIM TOKENS
--------------------------------*/
async function claimTokens() {
    try {
        const tx = await presale.claimTokens();
        document.getElementById("status").innerText = "Processando claim...";
        await tx.wait();

        document.getElementById("status").innerText = "Claim concluído!";
    }
    catch (err) {
        showPopup("popupClaim");
    }
}

/* ------------------------------
   POPUPS
--------------------------------*/
function showPopup(id) {
    const el = document.getElementById(id);
    el.style.display = "block";
    setTimeout(() => { el.style.display = "none"; }, 2500);
}

/* ------------------------------
   COUNTDOWN
--------------------------------*/
function startCountdown(endTime) {
    setInterval(() => {
        const now = Math.floor(Date.now() / 1000);
        const diff = endTime - now;

        if (diff <= 0) {
            document.getElementById("timer").innerText = "Presale encerrada!";
            return;
        }

        const d = Math.floor(diff / 86400);
        const h = Math.floor((diff % 86400) / 3600);
        const m = Math.floor((diff % 3600) / 60);
        const s = diff % 60;

        document.getElementById("timer").innerText =
            `${d}d ${h}h ${m}m ${s}s`;
    }, 1000);
}
</script>

</body>
</html>
