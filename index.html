<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PILL Presale - A Revolução Digital</title>

<script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>

<style>
/* Reset Básico */
body, html {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #00ffbf;
    background-color: #0a0a0a;
    overflow-x: hidden;
}

/* Efeito Matrix Background */
.matrix-bg {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    overflow: hidden;
    background: #0a0a0a;
    opacity: 0.2; 
}
.matrix-bg::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 200%; 
    background: repeating-linear-gradient(
        to bottom,
        transparent,
        transparent 1px,
        rgba(0, 255, 191, 0.05) 1px,
        rgba(0, 255, 191, 0.05) 2px
    );
    animation: scrollMatrix 60s linear infinite;
}

@keyframes scrollMatrix {
    from {
        transform: translateY(0);
    }
    to {
        transform: translateY(-50%);
    }
}


/* Layout Principal */
.container {
    max-width: 600px;
    margin: 80px auto;
    padding: 40px;
    border-radius: 20px;
    background: linear-gradient(145deg, rgba(0,0,0,0.8), rgba(10,10,10,0.9));
    border: 2px solid #00ffbf;
    box-shadow: 0 0 30px rgba(0, 255, 191, 0.4), 0 0 60px rgba(0, 255, 191, 0.2);
    text-align: center;
    position: relative;
    z-index: 1;
    animation: fadeIn 1s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}

h1 {
    color: #00ffc3;
    font-size: 2.8em;
    margin-bottom: 25px;
    text-shadow: 0 0 10px #00ffbf;
}

/* Estilo para o Cronômetro */
.timer-display {
    color: #ff0066; /* Cor de alerta */
    font-size: 1.4em;
    font-weight: bold;
    margin-bottom: 20px;
    padding: 10px;
    border: 1px dashed #ff0066;
    border-radius: 8px;
    background: rgba(255, 0, 102, 0.05);
}

/* Botões */
button {
    width: 90%;
    padding: 15px;
    margin-top: 15px;
    border: none;
    border-radius: 10px;
    font-size: 1.1em;
    font-weight: bold;
    cursor: pointer;
    background: linear-gradient(45deg, #00ffbf, #00e0a0);
    color: #0a0a0a;
    transition: all 0.3s ease-in-out;
    box-shadow: 0 4px 15px rgba(0, 255, 191, 0.3);
}

button:hover:not(:disabled) {
    background: linear-gradient(45deg, #ff0066, #e0005a);
    color: white;
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(255, 0, 102, 0.4);
}

button:disabled {
    cursor: not-allowed;
    opacity: 0.5;
    background: #333;
    color: #888;
    box-shadow: none;
}

/* Input */
input {
    width: 90%;
    padding: 14px;
    margin-top: 20px;
    border-radius: 10px;
    font-size: 1.1em;
    border: 1px solid #00ffbf;
    background: #1a1a1a;
    color: #00ffbf;
    transition: border-color 0.3s ease-in-out;
}
input:focus {
    outline: none;
    border-color: #00e0a0;
    box-shadow: 0 0 8px rgba(0, 255, 191, 0.6);
}

/* Info Cards e Displays */
#infoCard {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px dashed rgba(0, 255, 191, 0.3);
}

.info-item {
    background: rgba(0, 255, 191, 0.05);
    border-left: 3px solid #00ffbf;
    padding: 10px 15px;
    margin: 10px 0;
    border-radius: 8px;
    text-align: left;
    font-size: 1.1em;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.info-item span:first-child {
    font-weight: bold;
}
.info-item span:last-child {
    color: #00e0a0;
}

/* Barras de Progresso */
.progressBox {
    width: 100%;
    height: 25px;
    background: #222;
    border-radius: 15px;
    margin-top: 20px;
    overflow: hidden;
    border: 1px solid #00ffbf;
    position: relative;
}
.progressFill {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #00ffbf, #00e0a0);
    transition: width 0.8s ease-out;
    border-radius: 15px;
}
.progressText {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #0a0a0a;
    font-weight: bold;
    font-size: 0.9em;
    text-shadow: 0 0 3px #00ffbf;
}
.progressLabel {
    margin-top: 10px;
    font-size: 0.9em;
    color: rgba(0, 255, 191, 0.7);
}

/* Mensagens de Status */
#statusMessage {
    margin-top: 20px;
    font-weight: bold;
    min-height: 25px;
    font-size: 1.1em;
    color: #00ffaa;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.02); opacity: 0.9; }
    100% { transform: scale(1); opacity: 1; }
}

/* Responsividade */
@media (max-width: 768px) {
    .container {
        margin: 30px auto;
        padding: 20px;
    }
    h1 {
        font-size: 2.2em;
    }
    button, input {
        padding: 12px;
        font-size: 1em;
    }
    .info-item, .progressText {
        font-size: 0.9em;
    }
}
</style>
</head>
<body>


<div class="matrix-bg"></div>

<div class="container">
    <h1>PILL Presale</h1>
    <div class="timer-display" id="presaleTimer">Tempo Restante: --:--:--</div>
    <button id="connectBtn">Conectar MetaMask</button>
    <div id="statusMessage">Aguardando conexão com a MetaMask...</div>

    <div id="infoCard">
        <div class="info-item"><span>Preço do Token:</span> <span id="priceDisplay">-- ETH</span></div>
        <div class="info-item"><span>Tokens Vendidos:</span> <span id="tokensSold">--</span></div>
        <div class="info-item"><span>Tokens Restantes:</span> <span id="tokensRemaining">--</span></div>
        <div class="info-item"><span>Market Cap Atual:</span> <span id="marketCapDisplay">-- USD</span></div>
        <div class="info-item"><span>Total Arrecadado:</span> <span id="totalRaisedETHDisplay">-- ETH</span></div>
        
        <div class="progressLabel">Progresso da Presale: <span id="presaleProgressText">0%</span></div>
        <div class="progressBox">
            <div class="progressFill" id="presaleProgressFill"></div>
            <div class="progressText" id="presaleProgressLabel"></div>
        </div>

        <div class="progressLabel">Progresso para Market Cap Alvo: <span id="marketCapProgressText">0%</span></div>
        <div class="progressBox">
            <div class="progressFill" id="marketCapProgressFill"></div>
            <div class="progressText" id="marketCapProgressLabel"></div>
        </div>

        <input type="number" id="ethAmount" placeholder="Quantidade de ETH para comprar" min="0.001" step="0.001">
        <button id="buyBtn" disabled>Comprar PILL</button>
    </div>
</div>

<script>
// A função de inicialização que será chamada APÓS o carregamento completo do Ethers.js
function initDApp() {
    // Desestruturação do Ethers v6
    const { BrowserProvider, Contract, parseEther, formatEther, formatUnits } = ethers;

    let provider, signer, account, presaleContract;
    
    // ENDEREÇO DO SEU CONTRATO DEPLOYADO NA SEPOLIA
    const presaleAddress = "0x6b4cd06f01E2840525cBef2962Bce688fa5D6f04"; 
    
    // ABI COMPLETA
    const abiPresale = [
        "function buyTokens() payable",
        "function tokensSold() view returns(uint256)",
        "function tokenPrice() view returns(uint256)",
        "function progress() view returns(uint256)", 
        "function presaleActive() view returns(bool)",
        "function maxCapETH() view returns(uint256)",
        "function totalRaisedETH() view returns(uint256)" 
    ];

    // Mapeamento de IDs
    const elements = {
        connectBtn: document.getElementById("connectBtn"),
        buyBtn: document.getElementById("buyBtn"),
        ethAmountInput: document.getElementById("ethAmount"),
        statusMessage: document.getElementById("statusMessage"),
        presaleTimer: document.getElementById("presaleTimer"),
        priceDisplay: document.getElementById("priceDisplay"),
        tokensSoldDisplay: document.getElementById("tokensSold"),
        tokensRemainingDisplay: document.getElementById("tokensRemaining"),
        marketCapDisplay: document.getElementById("marketCapDisplay"),
        totalRaisedETHDisplay: document.getElementById("totalRaisedETHDisplay"),
        presaleProgressFill: document.getElementById("presaleProgressFill"),
        presaleProgressLabel: document.getElementById("presaleProgressLabel"),
        presaleProgressText: document.getElementById("presaleProgressText"),
        marketCapProgressFill: document.getElementById("marketCapProgressFill"),
        marketCapProgressLabel: document.getElementById("marketCapProgressLabel"),
        marketCapProgressText: document.getElementById("marketCapProgressText"),
    };

    // Chain ID da rede Sepolia (11155111)
    const requiredChainId = BigInt(11155111);

    // --- PARÂMETROS PARA CÁLCULO DE MARKET CAP E DURAÇÃO (FIXOS PARA DEMONSTRAÇÃO) ---
    const ETH_TO_USD_RATE = 2000; 
    const MARKET_CAP_GOAL_USD = 100000; 
    
    // Configuração do Cronômetro: 4 horas a partir do carregamento da página
    const PRESALE_DURATION_MS = 4 * 60 * 60 * 1000; // 4 horas em milissegundos
    const PRESALE_START_TIME = Date.now(); 
    // --------------------------------------------------------------------------


    function setStatus(message, isError = false) {
        if (elements.statusMessage) {
            elements.statusMessage.innerText = message;
            elements.statusMessage.style.color = isError ? '#ff0066' : '#00ffaa';
            elements.statusMessage.style.animation = isError ? 'none' : 'pulse 1.5s infinite';
        }
    }

    // Função de Cronômetro
    function updateTimer() {
        const elapsedTime = Date.now() - PRESALE_START_TIME;
        const remainingTime = PRESALE_DURATION_MS - elapsedTime;
        
        if (!elements.presaleTimer) return;

        if (remainingTime <= 0) {
            elements.presaleTimer.innerText = "Presale Encerrada!";
            // Se a presale acabar pelo tempo, desabilita o botão de compra
            if(elements.buyBtn) {
                 elements.buyBtn.disabled = true;
                 elements.buyBtn.innerText = "Encerrada por Tempo";
            }
            return;
        }

        const totalSeconds = Math.floor(remainingTime / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;

        const formatUnit = unit => String(unit).padStart(2, '0');

        elements.presaleTimer.innerText = `Tempo Restante: ${formatUnit(hours)}:${formatUnit(minutes)}:${formatUnit(seconds)}`;
    }

    // 1. Conectar MetaMask e verificar Rede
    async function connectWallet() {
        if (!window.ethereum) {
            setStatus("MetaMask não encontrada! Instale a extensão para continuar.", true);
            return;
        }
        if (!elements.connectBtn) return setStatus("Erro de inicialização: Botão de conexão não encontrado.", true);

        try {
            provider = new BrowserProvider(window.ethereum);

            const network = await provider.getNetwork();
            
            if (network.chainId !== requiredChainId) {
                 setStatus("Mude sua MetaMask para a rede Sepolia (ETH Testnet).", true);
                 await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0xaa36a7' }], 
                });
                return;
            }

            const accounts = await provider.send("eth_requestAccounts", []);
            account = accounts[0];
            signer = await provider.getSigner();
            
            presaleContract = new Contract(presaleAddress, abiPresale, signer);

            // Atualiza a UI para estado conectado
            elements.connectBtn.innerText = `Conectado: ${account.substring(0,6)}...${account.slice(-4)}`;
            elements.connectBtn.style.background = "#00ffaa";
            elements.connectBtn.disabled = true;
            if (elements.buyBtn) elements.buyBtn.disabled = false;

            updateUI(); 

            // Escuta por mudanças de conta/rede
            window.ethereum.on('accountsChanged', handleAccountsChanged);
            window.ethereum.on('chainChanged', handleChainChanged);

        } catch(err) {
            console.error("Erro ao conectar MetaMask:", err);
            let errorMsg = "Erro ao conectar. Veja o console para detalhes.";
            if (err.code === 4001) {
                errorMsg = "Conexão rejeitada pelo usuário.";
            }
            setStatus(errorMsg, true);
        }
    }

    function handleAccountsChanged(accounts) {
        if (accounts.length > 0) {
            location.reload(); 
        }
    }

    function handleChainChanged(chainId) {
        location.reload();
    }


    // 2. Atualizar UI (Lê dados do contrato)
    async function updateUI() {
        if (!presaleContract) return;

        try {
            const sold = await presaleContract.tokensSold();
            const price = await presaleContract.tokenPrice(); 
            const presaleProgress = await presaleContract.progress(); 
            const isActive = await presaleContract.presaleActive();
            const maxCapETH = await presaleContract.maxCapETH(); 
            const totalRaisedETH = await presaleContract.totalRaisedETH(); 

            // --- Conversão de Dados ---
            const soldTokensFormatted = parseFloat(formatUnits(sold, 18));
            const priceETH = parseFloat(formatEther(price));
            const totalRaisedETHFormatted = parseFloat(formatEther(totalRaisedETH)); 
            const maxCapETHFormatted = parseFloat(formatEther(maxCapETH));
            
            // --- Cálculos ---
            const marketCapCurrentUSD = (totalRaisedETHFormatted * ETH_TO_USD_RATE);
            const totalTokensAvailable = (maxCapETHFormatted / priceETH) * priceETH; 
            const tokensRemaining = totalTokensAvailable - soldTokensFormatted;
            const tokensRemainingFormatted = Math.max(0, tokensRemaining);
            const presalePct = Number(presaleProgress.toString());


            // --- Exibição ---
            if (elements.priceDisplay) elements.priceDisplay.innerText = `${priceETH.toFixed(8)} ETH`;
            if (elements.tokensSoldDisplay) elements.tokensSoldDisplay.innerText = soldTokensFormatted.toFixed(2);
            if (elements.tokensRemainingDisplay) elements.tokensRemainingDisplay.innerText = tokensRemainingFormatted.toFixed(2);
            if (elements.marketCapDisplay) elements.marketCapDisplay.innerText = `$${marketCapCurrentUSD.toFixed(2)} USD`;
            if (elements.totalRaisedETHDisplay) elements.totalRaisedETHDisplay.innerText = `${totalRaisedETHFormatted.toFixed(4)} ETH`;

            // --- Progresso da Presale (ETH vs MaxCap) ---
            if (elements.presaleProgressFill) elements.presaleProgressFill.style.width = Math.min(presalePct, 100) + "%";
            if (elements.presaleProgressLabel) elements.presaleProgressLabel.innerText = `${presalePct.toFixed(2)}%`;
            if (elements.presaleProgressText) elements.presaleProgressText.innerText = `${presalePct.toFixed(2)}%`;


            // --- Progresso do Market Cap Alvo (USD) ---
            const marketCapProgressPct = (marketCapCurrentUSD / MARKET_CAP_GOAL_USD) * 100;
            if (elements.marketCapProgressFill) elements.marketCapProgressFill.style.width = Math.min(marketCapProgressPct, 100) + "%";
            if (elements.marketCapProgressLabel) elements.marketCapProgressLabel.innerText = `${marketCapProgressPct.toFixed(2)}%`;
            if (elements.marketCapProgressText) elements.marketCapProgressText.innerText = `${marketCapProgressPct.toFixed(2)}%`;


            // --- Verificação de Estado ---
            if (!elements.buyBtn) return;

            if (!isActive || presalePct >= 100) {
                setStatus("Presale Finalizada (Cap atingido)!", true);
                elements.buyBtn.disabled = true;
                elements.buyBtn.innerText = "Finalizado";
            } else {
                setStatus(`Conectado à Sepolia. Progresso: ${presalePct.toFixed(2)}%`, false);
                elements.buyBtn.disabled = false;
                elements.buyBtn.innerText = "Comprar PILL";
            }

        } catch(err){
            console.error("Erro ao atualizar UI/ler contrato:", err);
            setStatus("Erro ao ler dados do contrato! Verifique o Endereço ou a Rede.", true);
        }
    }

    // 3. Comprar tokens (Envia transação)
    async function buyTokens() {
        if (!signer) return setStatus("Conecte a MetaMask primeiro.", true);
        if (!elements.ethAmountInput) return setStatus("Erro de inicialização: Campo de ETH não encontrado.", true);
        
        const ethAmount = elements.ethAmountInput.value;
        if (!ethAmount || parseFloat(ethAmount) <= 0) return setStatus("Insira um valor válido de ETH.", true);

        try {
            setStatus("Aguardando confirmação na MetaMask...", false);
            
            const valueToSend = parseEther(ethAmount);

            const tx = await presaleContract.buyTokens({ value: valueToSend });
            
            setStatus(`Transação enviada: ${tx.hash.substring(0, 10)}... Aguardando mineração.`, false);
            
            await tx.wait(); 
            
            setStatus("Compra de tokens confirmada com sucesso!", false);
            updateUI(); 

        } catch(err) {
            console.error("Erro na compra:", err);

            let errorMsg = "Erro ao comprar tokens. Verifique o console.";
            if (err.reason) {
                errorMsg = `Transação Revertida: ${err.reason}`;
            } else if (err.code === 4001) {
                errorMsg = "Transação rejeitada pelo usuário na MetaMask.";
            }
            setStatus(errorMsg, true);
        }
    }

    // Inicializa os event listeners
    if (elements.connectBtn) elements.connectBtn.addEventListener("click", connectWallet);
    if (elements.buyBtn) elements.buyBtn.addEventListener("click", buyTokens);

    // Inicia o cronômetro
    updateTimer();
    setInterval(updateTimer, 1000); // Atualiza o cronômetro a cada segundo

    // Atualiza UI a cada 10 segundos
    setInterval(() => {
        if (presaleContract) {
            updateUI();
        }
    }, 10000);
}

// Chama initDApp quando a janela estiver totalmente carregada
window.addEventListener('load', initDApp);

</script>

</body>
</html>
