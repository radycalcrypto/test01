<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PILL Token Presale Test</title>
<style>
body { margin:0; font-family:'Courier New', monospace; background:black; color:#00ff00; overflow-x:hidden; }
canvas { position:fixed; top:0; left:0; z-index:-1; }
.container { max-width:900px; margin:0 auto; padding:20px; text-align:center; }
h1 { font-size:3em; color:#00ffcc; margin-bottom:10px; }
h2 { font-size:2em; color:#ff00ff; }
.neon-button { background:#0ff; border:none; padding:15px 30px; color:black; font-size:1.2em; font-weight:bold; cursor:pointer; margin:10px; border-radius:10px; box-shadow:0 0 20px #0ff; transition:all 0.3s ease-in-out; }
.neon-button:hover { box-shadow:0 0 40px #0ff,0 0 80px #0ff; transform:scale(1.1); }
input[type="number"] { padding:10px; font-size:1em; width:150px; border-radius:8px; border:2px solid #0ff; margin:10px; background:black; color:#0ff; }
.progress-bar { background:#222; border:2px solid #0ff; border-radius:10px; margin:10px 0; width:100%; height:25px; overflow:hidden; }
.progress { background:#0ff; height:100%; width:0%; text-align:center; color:black; line-height:25px; font-weight:bold; }
.info-box { background:rgba(0,0,0,0.6); border:2px solid #0ff; border-radius:15px; padding:20px; margin:20px 0; }
.claim-bar { background:#111; border:2px solid #ff0; border-radius:10px; height:20px; width:100%; margin:10px 0; }
.claim-progress { background:#ff0; height:100%; width:0%; text-align:center; font-weight:bold; color:black; }
</style>
</head>
<body>

<canvas id="matrix"></canvas>

<div class="container">
  <h1>PILL Token Presale</h1>
  <h2>Token: PILL</h2>
  <div class="info-box">
    <p>Preço Inicial: <span id="tokenPrice">1.00 USD</span></p>
    <p>Total Capturado: <span id="totalRaised">0 USD</span></p>
    <p>Tokens Vendidos: <span id="tokensSold">0 / 100</span></p>
    <div class="progress-bar"><div class="progress" id="progressMarketCap">0%</div></div>
  </div>

  <button class="neon-button" id="connectWallet">Conectar MetaMask</button>

  <div class="info-box">
    <p>Comprar Tokens:</p>
    <input type="number" id="ethAmount" placeholder="ETH a investir" step="0.01" min="0">
    <button class="neon-button" id="buyTokens">Comprar</button>
  </div>

  <div class="info-box">
    <p>Claim Tokens:</p>
    <div class="claim-bar"><div class="claim-progress" id="claimProgress">0%</div></div>
  </div>
</div>

<!-- ===== Carregando ethers.js ===== -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<script>
window.addEventListener('DOMContentLoaded', () => {

  // ===== Matrix Effect =====
  const canvas = document.getElementById('matrix');
  const ctx = canvas.getContext('2d');
  canvas.height = window.innerHeight;
  canvas.width = window.innerWidth;
  const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@#$%^&*()*&^%';
  const fontSize = 16;
  const columns = canvas.width / fontSize;
  const drops = Array.from({length: columns}, () => 1);
  function drawMatrix() {
    ctx.fillStyle = 'rgba(0,0,0,0.05)';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = '#0ff';
    ctx.font = fontSize + 'px monospace';
    drops.forEach((y,i)=>{
      const text = letters[Math.floor(Math.random()*letters.length)];
      ctx.fillText(text,i*fontSize,y*fontSize);
      drops[i]++;
      if(drops[i]*fontSize>canvas.height && Math.random()>0.975) drops[i]=0;
    });
  }
  setInterval(drawMatrix,50);

  // ===== MetaMask Connection =====
  let provider, signer, userAddress;

  async function connectWallet() {
    try {
      if (!window.ethereum) throw new Error("MetaMask não detectada!");
      await window.ethereum.request({ method: 'eth_requestAccounts' });
      provider = new ethers.providers.Web3Provider(window.ethereum);
      signer = provider.getSigner();
      userAddress = await signer.getAddress();
      document.getElementById('connectWallet').innerText = 'Wallet Conectada';
      console.log('Conectado como:', userAddress);
    } catch(err) {
      console.error('Erro ao conectar MetaMask:', err);
      alert('Erro ao conectar MetaMask! Veja console.');
    }
  }
  document.getElementById('connectWallet').addEventListener('click', connectWallet);

  // ===== Configurações Presale =====
  const PRESALE_ADDRESS = "0xSEU_CONTRATO_AQUI"; // Substitua pelo endereço real
  const PRESALE_ABI = [ /* Cole a ABI do contrato aqui */ ];

  // ===== Variáveis UI =====
  let tokenPrice = 1.0;
  let totalRaised = 0;
  let tokensSold = 0;
  const maxCap = 100;

  function updateUI() {
    document.getElementById('tokenPrice').innerText = tokenPrice.toFixed(2) + ' USD';
    document.getElementById('totalRaised').innerText = totalRaised.toFixed(2) + ' USD';
    document.getElementById('tokensSold').innerText = `${tokensSold.toFixed(2)} / ${maxCap}`;
    const percent = (tokensSold/maxCap)*100;
    document.getElementById('progressMarketCap').style.width = percent + '%';
    document.getElementById('progressMarketCap').innerText = Math.floor(percent) + '%';
    document.getElementById('claimProgress').style.width = percent + '%';
    document.getElementById('claimProgress').innerText = Math.floor(percent) + '%';
  }

  // ===== Função de compra real =====
  async function buyTokens() {
    if(!signer) return alert('Conecte a MetaMask primeiro!');
    const ethAmount = parseFloat(document.getElementById('ethAmount').value);
    if(!ethAmount || ethAmount <= 0) return alert('Insira ETH válido');

    try {
      const contract = new ethers.Contract(PRESALE_ADDRESS, PRESALE_ABI, signer);
      const tx = await contract.buyTokens({ value: ethers.utils.parseEther(ethAmount.toString()) });
      console.log("Transação enviada:", tx.hash);
      await tx.wait();
      console.log("Transação confirmada!");

      // Atualiza UI após confirmação
      const tokensSoldRaw = await contract.tokensSold();
      const totalRaisedRaw = await contract.totalRaisedUSD();
      const tokenPriceRaw = await contract.tokenPriceUSD();

      tokensSold = parseFloat(ethers.utils.formatUnits(tokensSoldRaw, 18));
      totalRaised = parseFloat(totalRaisedRaw);
      tokenPrice = parseFloat(tokenPriceRaw);

      updateUI();
      alert("Compra realizada com sucesso!");
    } catch(err) {
      console.error("Erro na compra:", err);
      alert("Erro ao comprar tokens. Veja console.");
    }
  }

  document.getElementById('buyTokens').addEventListener('click', buyTokens);

  updateUI();

});
</script>

</body>
</html>
