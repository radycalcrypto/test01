<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PILL Presale Interface</title>

<!-- Ethers.js v5 -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>

<style>
body {
    margin:0; padding:0;
    background:black;
    color:#00ffbf;
    font-family:Arial, sans-serif;
    text-align:center;
}
.container {
    max-width:500px;
    margin:50px auto;
    padding:30px;
    border-radius:12px;
    background: rgba(0,0,0,0.7);
    border:1px solid #00ffbf;
}
h1 {
    color:#00ffc3;
}
button {
    width:90%;
    padding:14px;
    margin-top:12px;
    border:0;
    border-radius:10px;
    font-size:17px;
    font-weight:bold;
    cursor:pointer;
    background:#00ffbf;
    color:black;
    transition:0.3s;
}
button:hover {
    background:#ff0066;
    color:white;
}
input {
    width:90%;
    padding:12px;
    margin-top:14px;
    border-radius:8px;
    font-size:16px;
}
.progressBox {
    width:100%;
    height:22px;
    background:#222;
    border-radius:12px;
    margin-top:12px;
    overflow:hidden;
    border:1px solid #00ffbf;
}
.progressFill {
    height:100%;
    width:0%;
    background:#00ffaa;
    transition:0.4s;
}
</style>
</head>
<body>

<div class="container">
    <h1>PILL Presale</h1>
    <button id="connectBtn" onclick="connectWallet()">Conectar MetaMask</button>

    <div id="infoCard" style="margin-top:20px;">
        <div id="priceDisplay">Preço do token: -- ETH</div>
        <div id="tokensSold">Tokens vendidos: --</div>
        <div class="progressBox">
            <div class="progressFill" id="progressFill"></div>
        </div>
        <input type="number" id="ethAmount" placeholder="Quantidade de ETH" min="0" step="0.001">
        <button onclick="buyTokens()">Comprar</button>
    </div>
</div>

<script>
let provider, signer, account;
const presaleAddress = "0x6754c0f28ab363Ed6090843baeAb201C3CaCD96D"; // seu contrato PillPresaleETH

const abiPresale = [
    "function buyTokens() payable",
    "function tokensSold() view returns(uint256)",
    "function totalRaisedETH() view returns(uint256)",
    "function tokenPrice() view returns(uint256)",
    "function maxCapETH() view returns(uint256)"
];

let presaleContract;

async function connectWallet() {
    if (!window.ethereum) {
        alert("MetaMask não encontrada!");
        return;
    }

    try {
        await window.ethereum.request({ method: "eth_requestAccounts" });
        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        account = await signer.getAddress();

        presaleContract = new ethers.Contract(presaleAddress, abiPresale, signer);

        document.getElementById("connectBtn").innerText = 
            "Conectado: " + account.substring(0,6) + "..." + account.substring(38);
        document.getElementById("connectBtn").style.background="#00ffaa";

        updateUI();
    } catch(err) {
        console.error("Erro MetaMask:", err);
        alert("Erro ao conectar MetaMask! Veja console.");
    }
}

async function updateUI() {
    if (!presaleContract) return;
    try {
        const sold = await presaleContract.tokensSold();
        const price = await presaleContract.tokenPrice();
        const maxCap = await presaleContract.maxCapETH();

        document.getElementById("tokensSold").innerText = "Tokens vendidos: " + ethers.utils.formatUnits(sold,18);
        document.getElementById("priceDisplay").innerText = "Preço do token: " + ethers.utils.formatEther(price) + " ETH";

        const pct = Number(ethers.utils.formatUnits(sold,18)) / Number(ethers.utils.formatUnits(maxCap,18)) * 100;
        document.getElementById("progressFill").style.width = pct + "%";
    } catch(err){
        console.error("Erro ao atualizar UI:", err);
    }
}

async function buyTokens() {
    if (!signer) return alert("Conecte a MetaMask primeiro.");
    const ethAmount = document.getElementById("ethAmount").value;
    if (!ethAmount || ethAmount <= 0) return alert("Insira um valor válido.");

    try {
        const tx = await presaleContract.buyTokens({ value: ethers.utils.parseEther(ethAmount) });
        alert("Transação enviada. Confirme na MetaMask...");
        await tx.wait();
        alert("Compra confirmada!");
        updateUI();
    } catch(err) {
        console.error("Erro na compra:", err);
        alert("Erro ao comprar tokens. Veja console.");
    }
}

// Atualiza automaticamente a UI a cada 10 segundos
setInterval(updateUI,10000);
</script>

</body>
</html>
