<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PILL Presale | Matrix Protocol</title>

<script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>

<style>
/* Reset Básico */
body, html {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Consolas', 'Courier New', monospace; /* Fonte tech/cyberpunk */
    color: #00ffaa; /* Neon Verde/Ciano */
    background-color: #0d0d0d;
    overflow-x: hidden;
}

/* Efeito Matrix Background */
.matrix-bg {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    overflow: hidden;
    opacity: 0.1; /* Suave, não ofusca */
}
.matrix-bg::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 200%; 
    background: repeating-linear-gradient(
        to bottom,
        transparent,
        transparent 1px,
        #00ffaa33 1px, /* Linhas finas neon */
        #00ffaa33 2px
    );
    animation: scrollMatrix 60s linear infinite;
}

@keyframes scrollMatrix {
    from { transform: translateY(0); }
    to { transform: translateY(-50%); }
}

/* Layout Principal - Dashboard Clean */
.container {
    max-width: 450px;
    margin: 60px auto;
    padding: 30px;
    border-radius: 12px;
    background: rgba(0, 0, 0, 0.7);
    border: 1px solid #00ffaa33; 
    box-shadow: 0 0 15px #00ffaa44, 0 0 50px #00ffaa11;
    text-align: center;
    position: relative;
    z-index: 1;
    animation: fadeIn 1s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}

h1 {
    color: #00ffff; /* Ciano mais intenso */
    font-size: 2.5em;
    margin-bottom: 15px;
    text-shadow: 0 0 8px #00ffff, 0 0 15px #00ffaa;
    letter-spacing: 2px;
}

/* Estilo para o Cronômetro */
.timer-display {
    color: #ff0077; /* Cor de Alerta/Pílula Vermelha */
    font-size: 1.2em;
    font-weight: bold;
    margin-bottom: 25px;
    padding: 8px;
    border-bottom: 1px solid #ff007755;
    background: rgba(255, 0, 119, 0.05);
}

/* Botões */
button {
    width: 100%;
    padding: 14px;
    margin-top: 25px;
    border: none;
    border-radius: 8px;
    font-size: 1em;
    font-weight: bold;
    cursor: pointer;
    /* Neon Verde/Ciano */
    background: linear-gradient(45deg, #00ffaa, #00ffff);
    color: #0d0d0d;
    transition: all 0.3s ease-in-out;
    box-shadow: 0 4px 10px rgba(0, 255, 170, 0.4);
}

button#connectBtn {
    margin-bottom: 10px; 
}

button:hover:not(:disabled) {
    background: linear-gradient(45deg, #ff0077, #ff3399); /* Pílula Vermelha */
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(255, 0, 119, 0.6);
}

button:disabled {
    cursor: not-allowed;
    opacity: 0.4;
    background: #333;
    color: #888;
    box-shadow: none;
}

/* Input */
input {
    width: 100%;
    padding: 12px;
    margin-top: 15px;
    border-radius: 6px;
    font-size: 1em;
    border: 1px solid #00ffaa;
    background: #1a1a1a;
    color: #00ffff;
    text-align: center;
}
input:focus {
    outline: none;
    border-color: #00ffff;
    box-shadow: 0 0 5px #00ffff88;
}

/* Info Cards e Displays (Minimalista e Limpo) */
#infoCard {
    margin-top: 30px;
    padding-top: 20px;
}

.info-item {
    padding: 8px 0;
    margin: 5px 0;
    text-align: left;
    font-size: 1em;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px dashed #00ffaa11;
}
.info-item:last-child {
    border-bottom: none;
}

.info-item span:first-child {
    font-weight: normal;
    color: #00ffaa;
}
.info-item span:last-child {
    font-weight: bold;
    color: #00ffff;
    text-shadow: 0 0 2px #00ffff;
}

/* Barras de Progresso */
.progressLabel {
    margin-top: 20px;
    margin-bottom: 5px;
    font-size: 0.9em;
    color: #00ffaa;
    text-align: left;
}
.progressBox {
    width: 100%;
    height: 15px; /* Mais fino para ser minimalista */
    background: #333;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid #00ffaa66;
    position: relative;
    margin-bottom: 10px;
}
.progressFill {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #00ffaa, #00ffff);
    transition: width 0.8s ease-out;
    border-radius: 8px;
}
.progressText {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #0d0d0d;
    font-weight: bold;
    font-size: 0.7em;
    text-shadow: 0 0 1px #00ffff;
}

/* Mensagens de Status */
#statusMessage {
    margin-top: 10px;
    font-weight: bold;
    min-height: 25px;
    font-size: 0.9em;
    color: #00ffaa;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.01); opacity: 0.9; }
    100% { transform: scale(1); opacity: 1; }
}

/* Responsividade */
@media (max-width: 500px) {
    .container {
        margin: 20px;
        padding: 20px;
    }
    h1 {
        font-size: 2em;
    }
    button, input {
        padding: 10px;
    }
}
</style>
</head>
<body>


<div class="matrix-bg"></div>

<div class="container">
    <h1>PILL Presale</h1>
    <div class="timer-display" id="presaleTimer">Tempo Restante: --:--:--</div>
    <button id="connectBtn">Conectar MetaMask</button>
    <div id="statusMessage">Aguardando conexão com a MetaMask...</div>

    <div id="infoCard">
        <div class="info-item"><span>Preço do Token:</span> <span id="priceDisplay">-- ETH</span></div>
        <div class="info-item"><span>Tokens Vendidos:</span> <span id="tokensSold">--</span></div>
        <div class="info-item"><span>Tokens Restantes:</span> <span id="tokensRemaining">--</span></div>
        <div class="info-item"><span>Market Cap Atual:</span> <span id="marketCapDisplay">-- USD</span></div>
        <div class="info-item"><span>Total Arrecadado:</span> <span id="totalRaisedETHDisplay">-- ETH</span></div>
        
        <div class="progressLabel">Progresso da Presale: <span id="presaleProgressText">0%</span></div>
        <div class="progressBox">
            <div class="progressFill" id="presaleProgressFill"></div>
            <div class="progressText" id="presaleProgressLabel"></div>
        </div>

        <div class="progressLabel">Progresso para Market Cap Alvo ($500 USD): <span id="marketCapProgressText">0%</span></div>
        <div class="progressBox">
            <div class="progressFill" id="marketCapProgressFill"></div>
            <div class="progressText" id="marketCapProgressLabel"></div>
        </div>

        <input type="number" id="ethAmount" placeholder="Quantidade de ETH para comprar" min="0.001" step="0.001">
        <button id="buyBtn" disabled>Comprar PILL</button>
    </div>
</div>

<script>
function initDApp() {
    // Desestruturação do Ethers v6
    const { BrowserProvider, Contract, parseEther, formatEther, formatUnits } = ethers;

    let provider, signer, account, presaleContract;
    
    // ENDEREÇO DO SEU CONTRATO DEPLOYADO NA SEPOLIA (MANTER O SEU ENDEREÇO)
    const presaleAddress = "0x6b4cd06f01E2840525cBef2962Bce688fa5D6f04"; 
    
    // ABI COMPLETA (Assegure-se de que o seu contrato tem essas funções)
    const abiPresale = [
        "function buyTokens() payable",
        "function tokensSold() view returns(uint256)",
        "function tokenPrice() view returns(uint256)",
        "function presaleActive() view returns(bool)",
        "function maxCapETH() view returns(uint256)",
        "function totalRaisedETH() view returns(uint256)" 
    ];

    // Mapeamento de IDs
    const elements = {
        connectBtn: document.getElementById("connectBtn"),
        buyBtn: document.getElementById("buyBtn"),
        ethAmountInput: document.getElementById("ethAmount"),
        statusMessage: document.getElementById("statusMessage"),
        presaleTimer: document.getElementById("presaleTimer"),
        priceDisplay: document.getElementById("priceDisplay"),
        tokensSoldDisplay: document.getElementById("tokensSold"),
        tokensRemainingDisplay: document.getElementById("tokensRemaining"),
        marketCapDisplay: document.getElementById("marketCapDisplay"),
        totalRaisedETHDisplay: document.getElementById("totalRaisedETHDisplay"),
        presaleProgressFill: document.getElementById("presaleProgressFill"),
        presaleProgressLabel: document.getElementById("presaleProgressLabel"),
        presaleProgressText: document.getElementById("presaleProgressText"),
        marketCapProgressFill: document.getElementById("marketCapProgressFill"),
        marketCapProgressLabel: document.getElementById("marketCapProgressLabel"),
        marketCapProgressText: document.getElementById("marketCapProgressText"),
    };

    // Chain ID da rede Sepolia (11155111)
    const requiredChainId = BigInt(11155111);

    // --- PARÂMETROS DE CÁLCULO (CORRIGIDOS) ---
    const ETH_TO_USD_RATE = 2000; // Cotação estimada do ETH em USD
    const MARKET_CAP_GOAL_USD = 500; // Market Cap Alvo: $500 USD (CORRIGIDO)
    const USER_EXPECTED_TOKEN_PRICE_ETH = 0.0003; // Preço do Token (0.0003 ETH)
    
    // Total de Tokens Disponíveis na Presale (1000 Tokens) - AJUSTE MANUAL CONFORME SEU CONTRATO
    const TOTAL_TOKENS_AVAILABLE = 1000; 
    
    // Configuração do Cronômetro: 4 horas
    const PRESALE_DURATION_MS = 4 * 60 * 60 * 1000; 
    const PRESALE_START_TIME = Date.now(); 
    // --------------------------------------------------------------------------


    function setStatus(message, isError = false) {
        if (elements.statusMessage) {
            elements.statusMessage.innerText = message;
            elements.statusMessage.style.color = isError ? '#ff0077' : '#00ffaa';
            elements.statusMessage.style.animation = isError ? 'none' : 'pulse 1.5s infinite';
        }
    }

    // Função de Cronômetro
    function updateTimer() {
        const elapsedTime = Date.now() - PRESALE_START_TIME;
        const remainingTime = PRESALE_DURATION_MS - elapsedTime;
        
        if (!elements.presaleTimer) return;

        if (remainingTime <= 0) {
            elements.presaleTimer.innerText = "Presale Encerrada!";
            if(elements.buyBtn) {
                 elements.buyBtn.disabled = true;
                 elements.buyBtn.innerText = "Encerrada por Tempo";
            }
            return;
        }

        const totalSeconds = Math.floor(remainingTime / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;

        const formatUnit = unit => String(unit).padStart(2, '0');

        elements.presaleTimer.innerText = `Tempo Restante: ${formatUnit(hours)}:${formatUnit(minutes)}:${formatUnit(seconds)}`;
    }

    async function connectWallet() {
        if (!window.ethereum) {
            setStatus("MetaMask não encontrada! Instale a extensão para continuar.", true);
            return;
        }
        try {
            provider = new BrowserProvider(window.ethereum);

            const network = await provider.getNetwork();
            
            if (network.chainId !== requiredChainId) {
                 setStatus("Mude sua MetaMask para a rede Sepolia (ETH Testnet).", true);
                 await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0xaa36a7' }], 
                });
                return;
            }

            const accounts = await provider.send("eth_requestAccounts", []);
            account = accounts[0];
            signer = await provider.getSigner();
            
            presaleContract = new Contract(presaleAddress, abiPresale, signer);

            // Atualiza a UI para estado conectado
            elements.connectBtn.innerText = `Conectado: ${account.substring(0,6)}...${account.slice(-4)}`;
            elements.connectBtn.style.background = "#00ffaa";
            elements.connectBtn.disabled = true;
            if (elements.buyBtn) elements.buyBtn.disabled = false;

            updateUI(); 

            // Escuta por mudanças de conta/rede
            window.ethereum.on('accountsChanged', () => location.reload());
            window.ethereum.on('chainChanged', () => location.reload());

        } catch(err) {
            console.error("Erro ao conectar MetaMask:", err);
            let errorMsg = "Erro ao conectar. Tente novamente ou veja o console.";
            if (err.code === 4001) {
                errorMsg = "Conexão rejeitada pelo usuário.";
            }
            setStatus(errorMsg, true);
        }
    }


    // 2. Atualizar UI (Lê dados do contrato)
    async function updateUI() {
        if (!presaleContract) return;

        try {
            const sold = await presaleContract.tokensSold();
            const isActive = await presaleContract.presaleActive();
            const maxCapETH = await presaleContract.maxCapETH(); 
            const totalRaisedETH = await presaleContract.totalRaisedETH(); 

            // --- Conversão de Dados ---
            const soldTokensFormatted = parseFloat(formatUnits(sold, 18));
            const totalRaisedETHFormatted = parseFloat(formatEther(totalRaisedETH)); 
            const maxCapETHFormatted = parseFloat(formatEther(maxCapETH));
            
            // --- Cálculos CORRIGIDOS ---
            const marketCapCurrentUSD = (totalRaisedETHFormatted * ETH_TO_USD_RATE);

            // CÁLCULO DE TOKENS RESTANTES (Baseado no total fixo de 1000 tokens)
            const tokensRemaining = TOTAL_TOKENS_AVAILABLE - soldTokensFormatted;
            const tokensRemainingFormatted = Math.max(0, tokensRemaining);
            

            // PROGRESO DA PRESALE (Total Arrecadado vs. Max Cap do contrato)
            const presalePctRecalculated = (totalRaisedETHFormatted / maxCapETHFormatted) * 100;
            const finalPresalePct = Math.min(presalePctRecalculated, 100); 

            // PROGRESO DO MARKET CAP ALVO (Current USD vs. Target USD)
            const marketCapProgressPct = (marketCapCurrentUSD / MARKET_CAP_GOAL_USD) * 100;


            // --- Exibição ---
            if (elements.priceDisplay) elements.priceDisplay.innerText = `${USER_EXPECTED_TOKEN_PRICE_ETH.toFixed(8)} ETH`;
            
            // Verificação de Market Cap: Se o Market Cap Alvo for atingido, a porcentagem deve ser 100%
            const marketCapLabelText = `$${marketCapCurrentUSD.toFixed(2)} / $${MARKET_CAP_GOAL_USD.toFixed(2)} USD`;
            const presaleLabelText = `${totalRaisedETHFormatted.toFixed(4)} / ${maxCapETHFormatted.toFixed(4)} ETH`;


            if (elements.tokensSoldDisplay) elements.tokensSoldDisplay.innerText = soldTokensFormatted.toFixed(2);
            if (elements.tokensRemainingDisplay) elements.tokensRemainingDisplay.innerText = tokensRemainingFormatted.toFixed(2);
            if (elements.marketCapDisplay) elements.marketCapDisplay.innerText = `$${marketCapCurrentUSD.toFixed(2)} USD`;
            if (elements.totalRaisedETHDisplay) elements.totalRaisedETHDisplay.innerText = `${totalRaisedETHFormatted.toFixed(4)} ETH`;

            // --- Progresso da Presale (Barra 1) ---
            if (elements.presaleProgressFill) elements.presaleProgressFill.style.width = finalPresalePct + "%";
            if (elements.presaleProgressLabel) elements.presaleProgressLabel.innerText = presaleLabelText;
            if (elements.presaleProgressText) elements.presaleProgressText.innerText = `${finalPresalePct.toFixed(2)}%`;


            // --- Progresso do Market Cap Alvo (Barra 2) ---
            if (elements.marketCapProgressFill) elements.marketCapProgressFill.style.width = Math.min(marketCapProgressPct, 100) + "%";
            if (elements.marketCapProgressLabel) elements.marketCapProgressLabel.innerText = marketCapLabelText;
            if (elements.marketCapProgressText) elements.marketCapProgressText.innerText = `${marketCapProgressPct.toFixed(2)}%`;


            // --- Verificação de Estado ---
            if (!elements.buyBtn) return;

            if (!isActive || finalPresalePct >= 100) {
                setStatus("Presale Finalizada (Cap atingido)!", true);
                elements.buyBtn.disabled = true;
                elements.buyBtn.innerText = "Finalizado";
            } else {
                setStatus(`Conectado à Sepolia. Progresso: ${finalPresalePct.toFixed(2)}%`, false);
                elements.buyBtn.disabled = false;
                elements.buyBtn.innerText = "Comprar PILL";
            }

        } catch(err){
            console.error("Erro ao atualizar UI/ler contrato:", err);
            // Melhorando a mensagem de erro para o usuário:
            let displayError = "Erro ao ler dados do contrato! Verifique o Endereço ou a ABI.";
            if (err.message && err.message.includes('totalRaisedETH')) {
                 displayError = "Erro de ABI: A função 'totalRaisedETH' não foi encontrada. Atualize a ABI do contrato!";
            }
            setStatus(displayError, true);
        }
    }

    // 3. Comprar tokens (Envia transação)
    async function buyTokens() {
        if (!signer) return setStatus("Conecte a MetaMask primeiro.", true);
        
        const ethAmount = elements.ethAmountInput.value;
        if (!ethAmount || parseFloat(ethAmount) <= 0) return setStatus("Insira um valor válido de ETH.", true);

        try {
            setStatus("Aguardando confirmação na MetaMask...", false);
            
            const valueToSend = parseEther(ethAmount);

            const tx = await presaleContract.buyTokens({ value: valueToSend });
            
            setStatus(`Transação enviada: ${tx.hash.substring(0, 10)}... Aguardando mineração.`, false);
            
            await tx.wait(); 
            
            setStatus("Compra de tokens confirmada com sucesso! Atualizando dados...", false);
            updateUI(); 

        } catch(err) {
            console.error("Erro na compra:", err);

            let errorMsg = "Erro ao comprar tokens. Verifique o console.";
            if (err.reason) {
                errorMsg = `Transação Revertida: ${err.reason}`;
            } else if (err.code === 4001) {
                errorMsg = "Transação rejeitada pelo usuário na MetaMask.";
            }
            setStatus(errorMsg, true);
        }
    }

    // Inicializa os event listeners
    if (elements.connectBtn) elements.connectBtn.addEventListener("click", connectWallet);
    if (elements.buyBtn) elements.buyBtn.addEventListener("click", buyTokens);

    // Inicia o cronômetro
    updateTimer();
    setInterval(updateTimer, 1000); // Atualiza o cronômetro a cada segundo

    // Atualiza UI a cada 10 segundos
    setInterval(() => {
        if (presaleContract) {
            updateUI();
        }
    }, 10000);
}

// Chama initDApp quando a janela estiver totalmente carregada
window.addEventListener('load', initDApp);

</script>

</body>
</html>
